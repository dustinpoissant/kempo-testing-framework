<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kempo Testing Library GUI</title>
  <link rel="stylesheet" href="/essential.css" />
</head>
<body>
<main>
  <h1 class="ta-center">Kempo Testing Framework GUI</h1>

  <ktf-collapsible id="settings">
    <span slot="title"><ktf-icon name="settings"></ktf-icon> &nbsp; <b>Settings</b></span>

      <ktf-setting-checkbox name="showBrowser" label="Show Browser"></ktf-setting-checkbox>
      <div id="delaySettingRow">
        <ktf-setting-number name="delayMs" label="Delay (ms) between tests and around browser runs" step="100" min="0" max="600000" suffix="ms"></ktf-setting-number>
      </div>

      <ktf-setting-select name="logLevel" label="Log Level"></ktf-setting-select>

      <ktf-setting-select name="theme" label="Theme"></ktf-setting-select>
      
  </ktf-collapsible>

  <div id="nodeTestsContainer">
    <h2>Node Tests</h2>
    <div id="nodeTests"></div>
  </div>
  <div id="browserTestsContainer">
    <h2>Browser Tests</h2>
    <div id="browserTests"></div>
  </div>
</main>
<script type="module">
  import '/components/TestFile.js';
  import '/components/Icon.js';
  import '/components/Theme.js';
  import '/components/Collapsible.js';
  import '/components/SettingSelect.js';
  import '/components/SettingCheckbox.js';
  import '/components/SettingNumber.js';
  import { getSettings, setSettings, subscribe } from '/components/settingsStore.js';
  
  // Apply theme to document on load and when settings change
  const applyTheme = (s) => {
    const theme = s.theme || 'auto';
    document.documentElement.setAttribute('theme', theme);
  };
  applyTheme(getSettings());
  subscribe(applyTheme);
  
  // Toggle delay setting visibility with showBrowser
  const syncDelayVisibility = (s) => {
    const row = document.getElementById('delaySettingRow');
    if (row) row.style.display = s.showBrowser ? '' : 'none';
  };
  syncDelayVisibility(getSettings());
  subscribe(syncDelayVisibility);
  
  // Settings UI init (reserved for future)
  const els = { };
  const applyToControls = () => {};
  applyToControls(getSettings());
  subscribe(applyToControls);

  const testFiles = await(await fetch('/testFiles')).json();
  for (const browserTest of testFiles.browserTests) {
    try {
      const moduleUrl = `/test/${browserTest.file}`;
      const testModule = await import(moduleUrl);
      browserTest.testNames = testModule.default ? Object.keys(testModule.default) : [];
    } catch (error) {
      console.error(`Error importing test file ${browserTest.file}:`, error);
      browserTest.testNames = [];
    }
  }
  if(!testFiles?.browserTests?.length){
    document.getElementById('browserTestsContainer').style.display = 'none';
  } else {
    const browserTestsContainer = document.getElementById('browserTests');
    testFiles.browserTests.forEach(browserTest => {
      const testFileElement = document.createElement('ktf-test-file');
      testFileElement.file = browserTest.file;
      testFileElement.testNames = browserTest.testNames;
      browserTestsContainer.appendChild(testFileElement);
    });
  }
  if(!testFiles?.nodeTests?.length){
    document.getElementById('nodeTestsContainer').style.display = 'none';
  } else {
    const nodeTestsContainer = document.getElementById('nodeTests');
    testFiles.nodeTests.forEach(nodeTest => {
      const testFileElement = document.createElement('ktf-test-file');
      testFileElement.file = nodeTest.file;
      testFileElement.testNames = nodeTest.testNames || [];
      nodeTestsContainer.appendChild(testFileElement);
    });
  }
</script>
</body>
</html>