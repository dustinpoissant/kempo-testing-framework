<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kempo Testing Library GUI</title>
  <link rel="stylesheet" href="/kempo.css" />
  <style>
    .loading-state {
      padding: 1rem;
      text-align: center;
      color: #666;
      font-style: italic;
    }
    
    .empty-state {
      padding: 1rem;
      color: #888;
      background-color: #f5f5f5;
      border-radius: 4px;
      margin: 0.5rem 0;
    }
    
    .empty-state code {
      background-color: #e8e8e8;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
<main>
  <h1 class="ta-center">Kempo Testing Framework GUI</h1>

  <ktf-collapsible id="settings">
    <span slot="title"><ktf-icon name="settings"></ktf-icon> &nbsp; <b>Settings</b></span>

      <ktf-setting-checkbox name="showBrowser" label="Show Browser"></ktf-setting-checkbox>
      <div id="delaySettingRow">
        <ktf-setting-number name="delayMs" label="Delay (ms) between tests and around browser runs" step="100" min="0" max="600000" suffix="ms"></ktf-setting-number>
      </div>

      <ktf-setting-select name="logLevel" label="Log Level"></ktf-setting-select>

      <ktf-setting-select name="theme" label="Theme"></ktf-setting-select>
      
  </ktf-collapsible>

  <ktf-test-framework id="framework">
  <ktf-test-summary id="globalSummary"></ktf-test-summary>
  <div id="universalTestsContainer">
    <h2>Universal Tests</h2>
    <p>Tests that run in both Node and Browser environments</p>
    <div id="universalTestsLoading" class="loading-state">Loading universal tests...</div>
    <div id="universalTestsEmpty" class="empty-state" style="display: none;">No universal tests found. Create test files with <code>.test.js</code> extension to run tests in both environments.</div>
    <div id="universalTests"></div>
  </div>
  <div id="nodeTestsContainer">
    <h2>Node Tests</h2>
    <div id="nodeTestsLoading" class="loading-state">Loading Node tests...</div>
    <div id="nodeTestsEmpty" class="empty-state" style="display: none;">No Node-only tests found. Create test files with <code>.node-test.js</code> extension to run tests only in Node.</div>
    <div id="nodeTests"></div>
  </div>
  <div id="browserTestsContainer">
    <h2>Browser Tests</h2>
    <div id="browserTestsLoading" class="loading-state">Loading browser tests...</div>
    <div id="browserTestsEmpty" class="empty-state" style="display: none;">No browser-only tests found. Create test files with <code>.browser-test.js</code> extension to run tests only in the browser.</div>
    <div id="browserTests"></div>
  </div>
  </ktf-test-framework>
</main>
<script type="module">
  import '/components/TestSuite.js';
  import '/components/Icon.js';
  import '/components/Theme.js';
  import '/components/Collapsible.js';
  import '/components/SettingSelect.js';
  import '/components/SettingCheckbox.js';
  import '/components/SettingNumber.js';
  import '/components/TestSummary.js';
  import '/components/TestFramework.js';
  import { getSettings, setSettings, subscribe } from '/components/settingsStore.js';
  
  // Apply theme to document on load and when settings change
  const applyTheme = (s) => {
    const theme = s.theme || 'auto';
    document.documentElement.setAttribute('theme', theme);
  };
  applyTheme(getSettings());
  subscribe(applyTheme);
  
  // Toggle delay setting visibility with showBrowser
  const syncDelayVisibility = (s) => {
    const row = document.getElementById('delaySettingRow');
    if (row) row.style.display = s.showBrowser ? '' : 'none';
  };
  syncDelayVisibility(getSettings());
  subscribe(syncDelayVisibility);
  
  // Settings UI init (reserved for future)
  const els = { };
  const applyToControls = () => {};
  applyToControls(getSettings());
  subscribe(applyToControls);

  try {
    const testFiles = await(await fetch('/testFiles')).json();
    
    // Get the properly categorized test files from the API
    const nodeOnlyTests = testFiles.nodeTests || [];
    const browserOnlyTests = testFiles.browserTests || [];  
    const universalTests = testFiles.universalTests || [];
    
    // Load test names for browser-accessible tests (browser-only and universal)
    const browserAccessibleTests = [...browserOnlyTests, ...universalTests];
    for (const test of browserAccessibleTests) {
      try {
        const moduleUrl = `/test/${test.file}`;
        const testModule = await import(moduleUrl);
        test.testNames = testModule.default ? Object.keys(testModule.default) : [];
      } catch (error) {
        console.error(`Error importing test file ${test.file}:`, error);
        test.testNames = [];
      }
    }
    
    // Universal tests section (.test.js files)
    const universalTestsLoading = document.getElementById('universalTestsLoading');
    const universalTestsEmpty = document.getElementById('universalTestsEmpty');
    const universalTestsContainer = document.getElementById('universalTests');
    
    universalTestsLoading.style.display = 'none';
    if(!universalTests?.length){
      universalTestsEmpty.style.display = 'block';
    } else {
      universalTests.forEach(universalTest => {
        const testFileElement = document.createElement('ktf-test-suite');
        testFileElement.file = universalTest.file;
        testFileElement.testNames = universalTest.testNames;
        testFileElement.setAttribute('universal', 'true'); // Mark as universal for special handling
        universalTestsContainer.appendChild(testFileElement);
      });
    }
    
    // Node-only tests section
    const nodeTestsLoading = document.getElementById('nodeTestsLoading');
    const nodeTestsEmpty = document.getElementById('nodeTestsEmpty');
    const nodeTestsContainer = document.getElementById('nodeTests');
    
    nodeTestsLoading.style.display = 'none';
    if(!nodeOnlyTests?.length){
      nodeTestsEmpty.style.display = 'block';
    } else {
      nodeOnlyTests.forEach(nodeTest => {
        const testFileElement = document.createElement('ktf-test-suite');
        testFileElement.file = nodeTest.file;
        testFileElement.testNames = nodeTest.testNames || [];
        nodeTestsContainer.appendChild(testFileElement);
      });
    }
    
    // Browser-only tests section
    const browserTestsLoading = document.getElementById('browserTestsLoading');
    const browserTestsEmpty = document.getElementById('browserTestsEmpty');
    const browserTestsContainer = document.getElementById('browserTests');
    
    browserTestsLoading.style.display = 'none';
    if(!browserOnlyTests?.length){
      browserTestsEmpty.style.display = 'block';
    } else {
      browserOnlyTests.forEach(browserTest => {
        const testFileElement = document.createElement('ktf-test-suite');
        testFileElement.file = browserTest.file;
        testFileElement.testNames = browserTest.testNames;
        browserTestsContainer.appendChild(testFileElement);
      });
    }
    
  } catch (error) {
    console.error('Error loading test files:', error);
    
    // Hide loading states and show error messages
    document.getElementById('universalTestsLoading').style.display = 'none';
    document.getElementById('nodeTestsLoading').style.display = 'none';
    document.getElementById('browserTestsLoading').style.display = 'none';
    
    // Show error messages
    const errorMsg = 'Error loading test files. Please check the console for details.';
    document.getElementById('universalTestsEmpty').textContent = errorMsg;
    document.getElementById('universalTestsEmpty').style.display = 'block';
    document.getElementById('nodeTestsEmpty').textContent = errorMsg;
    document.getElementById('nodeTestsEmpty').style.display = 'block';
    document.getElementById('browserTestsEmpty').textContent = errorMsg;
    document.getElementById('browserTestsEmpty').style.display = 'block';
  }
</script>
</body>
</html>